!function(){!function(){function a(){return exports.colors[r++%exports.colors.length]}function b(b){function c(){}function d(){var b=d,c=+new Date,e=c-(q||c);b.diff=e,b.prev=q,b.curr=c,q=c,null==b.useColors&&(b.useColors=exports.useColors()),null==b.color&&b.useColors&&(b.color=a());var f=Array.prototype.slice.call(arguments);f[0]=exports.coerce(f[0]),"string"!=typeof f[0]&&(f=["%o"].concat(f));var g=0;f[0]=f[0].replace(/%([a-z%])/g,function(a,c){if("%%"===a)return a;g++;var d=exports.formatters[c];if("function"==typeof d){var e=f[g];a=d.call(b,e),f.splice(g,1),g--}return a}),"function"==typeof exports.formatArgs&&(f=exports.formatArgs.apply(b,f));var h=d.log||exports.log||console.log.bind(console);h.apply(b,f)}c.enabled=!1,d.enabled=!0;var e=exports.enabled(b)?d:c;return e.namespace=b,e}function c(a){exports.save(a);for(var b=(a||"").split(/[\s,]+/),c=b.length,d=0;c>d;d++)b[d]&&(a=b[d].replace(/\*/g,".*?"),"-"===a[0]?exports.skips.push(new RegExp("^"+a.substr(1)+"$")):exports.names.push(new RegExp("^"+a+"$")))}function d(){exports.enable("")}function e(a){var b,c;for(b=0,c=exports.skips.length;c>b;b++)if(exports.skips[b].test(a))return!1;for(b=0,c=exports.names.length;c>b;b++)if(exports.names[b].test(a))return!0;return!1}function f(a){return a instanceof Error?a.stack||a.message:a}function g(a,b){return b=b||{},"string"==typeof a?h(a):b["long"]?j(a):i(a)}function h(a){var b=/^((?:\d+)?\.?\d+) *(ms|seconds?|s|minutes?|m|hours?|h|days?|d|years?|y)?$/i.exec(a);if(b){var c=parseFloat(b[1]),d=(b[2]||"ms").toLowerCase();switch(d){case"years":case"year":case"y":return c*w;case"days":case"day":case"d":return c*v;case"hours":case"hour":case"h":return c*u;case"minutes":case"minute":case"m":return c*t;case"seconds":case"second":case"s":return c*s;case"ms":return c}}}function i(a){return a>=v?Math.round(a/v)+"d":a>=u?Math.round(a/u)+"h":a>=t?Math.round(a/t)+"m":a>=s?Math.round(a/s)+"s":a+"ms"}function j(a){return k(a,v,"day")||k(a,u,"hour")||k(a,t,"minute")||k(a,s,"second")||a+" ms"}function k(a,b,c){return b>a?void 0:1.5*b>a?Math.floor(a/b)+" "+c:Math.ceil(a/b)+" "+c+"s"}function l(){return"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31}function m(){var a=arguments,b=this.useColors;if(a[0]=(b?"%c":"")+this.namespace+(b?" %c":" ")+a[0]+(b?"%c ":" ")+"+"+exports.humanize(this.diff),!b)return a;var c="color: "+this.color;a=[a[0],c,"color: inherit"].concat(Array.prototype.slice.call(a,1));var d=0,e=0;return a[0].replace(/%[a-z%]/g,function(a){"%%"!==a&&(d++,"%c"===a&&(e=d))}),a.splice(e,0,c),a}function n(){return"object"==typeof console&&"function"==typeof console.log&&Function.prototype.apply.call(console.log,console,arguments)}function o(a){try{null==a?localStorage.removeItem("debug"):localStorage.debug=a}catch(b){}}function p(){var a;try{a=localStorage.debug}catch(b){}return a}exports=window.debug=b,exports.coerce=f,exports.disable=d,exports.enable=c,exports.enabled=e,exports.humanize=g,exports.names=[],exports.skips=[],exports.formatters={};var q,r=0,s=1e3,t=60*s,u=60*t,v=24*u,w=365.25*v;exports.log=n,exports.formatArgs=m,exports.save=o,exports.load=p,exports.useColors=l,exports.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],exports.formatters.j=function(a){return JSON.stringify(a)},exports.enable(p())}(),Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e});var a=function(b){return this instanceof a?(this.isPolling=b||!1,this.httpRequest=this.getHttpRequestObject(),this.httpRequest.onreadystatechange=this._readystatechange.bind(this),this.readyState=this.httpRequest.readyState,this.pollingTTL=25,this.UNSENT=0,this.OPENED=1,this.HEADERS_RECEIVED=2,this.LOADING=3,void(this.DONE=4)):new a};a.prototype.triggerEvent=function(a){if(this["on"+a]){var b=Array.prototype.slice.call(arguments,1);this["on"+a].apply(this,b)}},a.prototype.getHttpRequestObject=function(){if(window.XMLHttpRequest)httpRequest=new XMLHttpRequest;else if(window.ActiveXObject)try{httpRequest=new ActiveXObject("Msxml2.XMLHTTP")}catch(a){try{httpRequest=new ActiveXObject("Microsoft.XMLHTTP")}catch(a){}}if(!httpRequest)throw new Error("Unable to create XLM HTTP request");return httpRequest},a.prototype.onreadystatechange=null,a.prototype.ondone=null,a.prototype.onopen=null,a.prototype.onheadersreceived=null,a.prototype.onloading=null,a.prototype.ondone=null,a.prototype.onerror=null,a.prototype.onclose=null,a.prototype.onmessage=null,a.prototype.ontimeout=null,a.prototype.onaborted=null,a.prototype.stopKillTimer=function(){this.killTimer&&(clearTimeout(this.killTimer),this.killTimer=null)},a.prototype.startKillTimer=function(){this.stopKillTimer(),this.killTimer=setTimeout(function(){this.httpRequest.readyState<=this.OPENED?(this.httpRequest.abort(),this.triggerEvent("aborted")):this.startKillTimer()}.bind(this),1e3*this.pollingTTL)},a.prototype._readystatechange=function(){if(this.readyState=this.httpRequest.readyState,this.httpRequest.readyState===this.OPENED)this.triggerEvent("open"),this.isPolling&&this.startKillTimer();else if(this.httpRequest.readyState===this.HEADERS_RECEIVED)this.stopKillTimer();else if(this.httpRequest.readyState===this.LOADING)this.stopKillTimer();else if(this.httpRequest.readyState===this.DONE)if(this.stopKillTimer(),"unknown"==typeof this.httpRequest.status){var a=new Error("Connection aborted");this.triggerEvent("error",a,this),this.triggerEvent("close")}else if(200===this.httpRequest.status)this.triggerEvent("message",this.httpRequest.responseText),this.triggerEvent("done",this.httpRequest.responseText),this.triggerEvent("close");else{var a=new Error("Connection failed with HTTP code: "+this.httpRequest.status);this.triggerEvent("error",a,this),this.triggerEvent("close")}this.triggerEvent("readystatechange",arguments)},a.prototype.post=function(a,b){this.method="POST",this.url=a,this.post=b,this.httpRequest.open("POST",a,!0),this.httpRequest.onerror=function(){console.log("got a post error!!!"),console.log(arguments)},this.httpRequest.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),this.httpRequest.setRequestHeader("X-API-URL",a),this.httpRequest.send(b)},a.prototype.get=function(a){this.method="GET",this.url=a,this.httpRequest.setRequestHeader("X-API-URL",a),this.httpRequest.open("GET",a,!0),this.httpRequest.onerror=function(){console.log("got a get error!!!"),console.log(arguments)},this.httpRequest.send()};var b=function(a){return this instanceof b?(this.initialConnectionDone=!1,this.retryTimeout=0,this.retryTimer=null,this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.readyState=this.CLOSED,this.internalState=this.CLOSED,this.url=a.replace(/^ws/i,"http"),this.connId=null,this.pollXHR=null,this.startPoll(),void(this.messageQueue=[])):new b};b.prototype.triggerEvent=function(a){if(sockit.debug.client("TRIGGER EVENT: on"+a),this["on"+a]){var b=Array.prototype.slice.call(arguments,1);this["on"+a].apply(this,b)}},b.prototype.onopen=null,b.prototype.onclose=null,b.prototype.onmessage=null,b.prototype.onerror=null,b.prototype.startPoll=function(){this.readyState=this.CONNECTING;var b=this.url+"poll-start",c=new a;c.ondone=function(a){if(this.readyState=this.OPEN,this.internalState=this.CLOSED,!a||!a.length||"poll-start="!==a.substr(0,11))throw new Error("No connection received");this.connId=a.substr(11),this.openPoll()}.bind(this),c.onerror=function(){this.internalState=this.CLOSED,this.triggerEvent("error",{},arguments),this.triggerEvent("close",{},arguments)}.bind(this),c.post(b)},b.prototype.openPoll=function(){return this.internalState===this.CLOSED&&this.connId?this.retryTimeout?(null!==this.retryTimer&&clearTimeout(this.retryTimer),void(this.retryTimer=setTimeout(function(){this._openPoll()}.bind(this),this.retryTimeout))):this._openPoll():!1},b.prototype._openPoll=function(){sockit.debug.conn("Trying to open poll connection"),this.internalState=this.CONNECTING;var b=this.url+this.connId+"/poll";this.pollXHR=new a(!0),this.pollXHR.onopen=function(){sockit.debug.xhr("Event: open"),this.internalState=this.OPEN,this.initialConnectionDone||(this.initialConnectionDone=!0,this.triggerEvent("open"))}.bind(this),this.pollXHR.ondone=function(a){if(sockit.debug.xhr("Event: done"),this.retryTimeout=0,this.internalState=this.CLOSED,"poll-start="===a.substr(0,11))this.connId=a.substr(11);else{sockit.debug.xhr("Raw data received"),sockit.debug.xhr(a);var b=JSON.parse(a);sockit.debug.xhr("Parsed data received"),sockit.debug.xhr(b);for(var c in b)this.triggerEvent("message",{type:"message",data:b[c]})}}.bind(this),this.pollXHR.onaborted=function(){this.internalState=this.CLOSED,this.retryTimeout=0}.bind(this),this.pollXHR.onerror=function(){this.internalState=this.CLOSED,this.retryTimeout||(this.retryTimeout=100),this.retryTimeout=Math.ceil(1.5*this.retryTimeout),this.retryTimeout>1e4&&(this.retryTimeout=1e4)}.bind(this),this.pollXHR.onclose=function(){sockit.debug.xhr("Event: close"),this.internalState=this.CLOSED,this.openPoll()}.bind(this),this.connection=this.pollXHR.post(b)},b.prototype.send=function(a){this.messageQueue.push(a),setTimeout(this.sendMessages.bind(this),25)},b.prototype.sendMessages=function(){if(this.messageQueue.length){var b=this.messageQueue.splice(0,this.messageQueue.length),c=this.url+this.connId+"/poll-msg",d=new a;d.onaborted=function(){this.reSendMessages(b)}.bind(this),d.onerror=function(){this.reSendMessages(b)}.bind(this),d.ondone=function(a){"poll-start="===a.substr(0,11)&&(this.connId=a.substr(11),this.reSendMessages(b))}.bind(this),sockit.debug.client("Sending message"),sockit.debug.client(b),d.post(c,JSON.stringify(b))}},b.prototype.reSendMessages=function(a){for(var b=a.length;b>0;b--)this.messageQueue.unshift(a[b-1]);this.sendMessages()};var c=function(a){return this instanceof c?(a=a||{},this._transport=null,this._transportType="websocket",this._initialConnectionDone=!1,this.url=a.url||"/sock.it/",this.URL=this.url,this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.readyState=this.CLOSED,this.bufferedAmount=0,this.extensions="",this.protocol="",this.binaryType="blob",this._setupConf(),void this._initiateConnection()):new c(url,protocols)};c.prototype.onopen=null,c.prototype.onclose=null,c.prototype.onmessage=null,c.prototype.onerror=null,c.prototype._triggerEvent=function(a){if(this.debug.client("trigger event: "+a),this["on"+a]){var b=Array.prototype.slice.call(arguments,1);this["on"+a].apply(this,b)}},c.prototype._setupConf=function(){this.url.match(/(http|https|ws|wss):\/\//i)?this.url=this.url.replace(/^http/i,"ws"):(this.url=this.url.replace(/^\.+\//i,""),this.url=this.url.replace(/^([^\/])/i,"/$1"),this.url=[window.location.protocol,"//",window.location.host,this.url].join("")),this.url=this.url.replace(/([^\/])$/i,"$1/"),"WebSocket"in window||(this._transportType="poll"),this.debug={},this.debug.todo=debug("sockit:todo"),this.debug.todo.color=debug.colors[1],this.debug.err=debug("sockit:errors"),this.debug.err.color=debug.colors[1],this.debug.xhr=debug("sockit:xhr"),this.debug.xhr.color=debug.colors[999],this.debug.client=debug("sockit:client"),this.debug.client.color=debug.colors[3],this.debug.conn=debug("sockit:connection"),this.debug.conn.color=debug.colors[2],this.debug.msgIn=debug("sockit:message-in"),this.debug.msgIn.color=debug.colors[4],this.debug.msgOut=debug("sockit:message-out"),this.debug.msgOut.color=debug.colors[6],this.debug.relay=debug("sockit:relay"),this.debug.relay.color=debug.colors[7]},c.prototype._initiateConnection=function(){if(this.debug.conn("Try to open a connection with "+this._transportType),"websocket"===this._transportType){var a=this.url.replace(/^http/i,"ws");this._transport=new WebSocket(a)}else if("poll"===this._transportType){var a=this.url.replace(/^ws/i,"http");this._transport=new b(a)}this._setupTransportListeners()},c.prototype.send=function(a){this.debug.msgOut("send this should be from browserBackend to server (via XHR)"),this.debug.msgOut(a),a||console.log("GOT A BROKEN MESSAGE FROM .send"),this._transport.send(a)},c.prototype._setupTransportListeners=function(){this._transport.onopen=function(){this.debug.conn("connection opened with "+this._transportType),this.readyState=this._transport.readyState,this._initialConnectionDone||(this._initialConnectionDone=!0,this._triggerEvent("open",arguments))}.bind(this),this._transport.onmessage=function(){this.debug.msgIn("received message with "+this._transportType),this.debug.msgIn(arguments);var a=Array.prototype.slice.call(arguments);a.unshift("message"),this.readyState=this._transport.readyState,this._triggerEvent.apply(this,a)}.bind(this),this._transport.onclose=function(){this._initialConnectionDone||"websocket"!==this._transportType?(this.readyState=this._transport.readyState,this._triggerEvent("close",arguments)):(this._transportType="poll",this._initiateConnection())}.bind(this),this._transport.onerror=function(){this.readyState=this._transport.readyState,this._triggerEvent("error",arguments)}.bind(this)},window.SockIt=c}();